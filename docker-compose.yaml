# persistent storage
volumes:
  sqlserver_data:
  sqlserver_scripts:
  kodb_util_data:
  server_config:

# shared container network
networks:
  backend:

# Use 'docker-compose down --rmi all -v' to completely remove database images.
# This is useful for when you want to reset the database to the current
# standard saved in the OpenKO-db project.
services:
  # Microsoft SQL Server service
  sqlserver:
    #image: mcr.microsoft.com/mssql/server:2022-latest
    build: docker/sqlserver
    # required to make docker desktop (windows) behave correctly
    x-buildkit: true
    networks:
      - backend
    env_file:
      - path: .env
        required: false
    environment:
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD:-D0ckeIzKn!ght}
    ports:
      # internal port is always 1433, but it can be port-forwarded to 
      # a different host port using SQL_PORT
      - ${SQL_PORT:-1433}:1433
    volumes:
      - sqlserver_data:/var/opt/mssql
      - sqlserver_scripts:/var/opt/appscripts
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "/var/opt/appscripts/healthcheck.sh"]
      interval: 3s
      retries: 30
      start_period: 10s
      timeout: 3s
  sqlserver.configurator:
    #image: mcr.microsoft.com/mssql/server:2022-latest
    build: docker/sqlserver
    # required to make docker desktop (windows) behave correctly
    x-buildkit: true
    env_file:
      - path: .env
        required: false
    environment:
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD:-D0ckeIzKn!ght}
    volumes:
      - ./init:/docker-entrypoint-initdb.d
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - backend
    command: >
      bash -c '
      /var/opt/appscripts/configurator.sh;
      '

  # Service to do a clean load of the KN_online database from Git
  kodb-util:
    build: docker/kodb-util/
    # required to make docker desktop (windows) behave correctly
    x-buildkit: true
    environment:
      - MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD:-D0ckeIzKn!ght}
      - SQL_PORT=${SQL_PORT:-1433}
      - GAME_DB_NAME=${GAME_DB_NAME:-KN_online}
      - GAME_DB_USER=${GAME_DB_USER:-knight}
      - GAME_DB_PASS=${GAME_DB_PASS:-knight}
      - GAME_DB_SCHEMA=${GAME_DB_SCHEMA:-knight}
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - backend
    env_file:
      - path: .env
        required: false
    volumes:
      - kodb_util_data:/var/lib/app

  # AI Server - Handles AI logic for NPCs
  aiserver:
    build:
      context: .
      dockerfile: docker/server/Dockerfile
    x-buildkit: true
    depends_on:
      sqlserver:
        condition: service_healthy
      kodb-util:
        condition: service_started
    networks:
      - backend
    env_file:
      - path: .env
        required: false
    volumes:
      - server_config:/app/config
    command: ["AIServer", "AIServer.ini"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f AIServer || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Aujard - Authentication and account management server
  aujard:
    build:
      context: .
      dockerfile: docker/server/Dockerfile
    x-buildkit: true
    depends_on:
      sqlserver:
        condition: service_healthy
      kodb-util:
        condition: service_started
    networks:
      - backend
    env_file:
      - path: .env
        required: false
    volumes:
      - server_config:/app/config
    command: ["Aujard", "Aujard.ini"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f Aujard || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Ebenezer - Main game server
  ebenezer:
    build:
      context: .
      dockerfile: docker/server/Dockerfile
    x-buildkit: true
    depends_on:
      sqlserver:
        condition: service_healthy
      kodb-util:
        condition: service_started
      aiserver:
        condition: service_started
      aujard:
        condition: service_started
    networks:
      - backend
    ports:
      - "${EBENEZER_PORT:-15100}:15100"
    env_file:
      - path: .env
        required: false
    volumes:
      - server_config:/app/config
    command: ["Ebenezer", "Ebenezer.ini"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f Ebenezer || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ItemManager - Handles item management
  itemmanager:
    build:
      context: .
      dockerfile: docker/server/Dockerfile
    x-buildkit: true
    depends_on:
      sqlserver:
        condition: service_healthy
      kodb-util:
        condition: service_started
    networks:
      - backend
    env_file:
      - path: .env
        required: false
    volumes:
      - server_config:/app/config
    command: ["ItemManager"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f ItemManager || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # VersionManager - Handles version management and updates
  versionmanager:
    build:
      context: .
      dockerfile: docker/server/Dockerfile
    x-buildkit: true
    depends_on:
      sqlserver:
        condition: service_healthy
      kodb-util:
        condition: service_started
    networks:
      - backend
    env_file:
      - path: .env
        required: false
    volumes:
      - server_config:/app/config
    command: ["VersionManager", "VersionManager.ini"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f VersionManager || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3